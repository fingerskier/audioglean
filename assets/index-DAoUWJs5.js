(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))a(t);new MutationObserver(t=>{for(const o of t)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function l(t){const o={};return t.integrity&&(o.integrity=t.integrity),t.referrerPolicy&&(o.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?o.credentials="include":t.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(t){if(t.ep)return;t.ep=!0;const o=l(t);fetch(t.href,o)}})();const m=["A","A#","B","C","C#","D","D#","E","F","F#","G","G#"],h={C:210,"C#":240,D:270,"D#":300,E:330,F:0,"F#":30,G:60,"G#":90,A:120,"A#":150,B:180},b=[2,3,4,5,6],L=document.getElementById("chroma-chart"),U={type:"doughnut",data:{labels:m,datasets:[{data:Array(12).fill(1),backgroundColor:m.map(e=>`hsl(${h[e]}, 100%, 50%)`),borderColor:"rgba(255,255,255,0.2)",borderWidth:1,borderAlign:"inner"},...b.map(()=>({data:Array(12).fill(1),backgroundColor:Array(12).fill("rgba(0,0,0,0.1)"),borderColor:"rgba(255,255,255,0.2)",borderWidth:1,borderAlign:"inner"}))]},options:{legend:{display:!1},responsive:!0,onResize:function(e,r){e.options.plugins.datalabels.offset=.04*r.width,e.update()},title:{display:!1},cutoutPercentage:30,animation:{animateRotate:!1,animateScale:!0},tooltips:{enabled:!1},plugins:{datalabels:{display:!1}}}};let n,B=!1,g,w=4096,I=1024,y,d,f;try{const e=window.AudioContext||window.webkitAudioContext;g=new e}catch(e){throw"Could not instantiate AudioContext: "+e.message}let M,c,A,E;const C=50;function O(e,r,l,a){if(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,navigator.getUserMedia)console.log("Initializing audio..."),navigator.getUserMedia({audio:!0,video:!1},function(t){if(M=t,M.active)console.log("Audio context sample rate = "+e.sampleRate),y=e.createMediaStreamSource(t),console.log("Buffer size = "+r),e.state=="suspended"&&e.resume(),d=e.createScriptProcessor(r,1,1),d.onaudioprocess=l,f=e.createGain(),f.gain.setValueAtTime(0,e.currentTime),y.connect(d),d.connect(f),f.connect(e.destination),a&&a();else throw"Mic stream not active"},function(t){throw"Could not access microphone - "+t});else throw"Could not access microphone - getUserMedia not available"}function G(){console.log("Stopped recording ..."),M.getAudioTracks().forEach(function(e){e.stop()}),$("#recordButton").removeClass("recording"),$("#recordButton").html('Mic &nbsp;&nbsp;<i class="microphone icon"></i>'),g.suspend().then(()=>{y.disconnect(),f.disconnect(),d.disconnect(),d=null})}function x(e){let r=e.inputBuffer.getChannelData(0);const l=n.RMS(n.arrayToVector(r)).rms,a=20*Math.log10(l),t=Math.min(Math.max((a+60)/60,0),1);if(A&&E&&(A.style.width=t*100+"%",E.textContent=a.toFixed(1)+" dB"),l>=.02){const i=n.hpcpExtractor(r).map(s=>100*Math.tanh(Math.pow(s*.5,2)));c.data.datasets[0].backgroundColor=m.map((s,u)=>{const p=C+i[u]*(100-C)/100;return`hsl(${h[s]}, 100%, ${p}%)`});const S=n.PitchYin(n.arrayToVector(r),w,!0,22050,20,g.sampleRate,.1);let v=-1,R=-1;if(S.pitch>0){const s=Math.round(12*Math.log2(S.pitch/440)+69);R=(s%12+3)%12;const p=Math.floor(s/12)-1;v=b.indexOf(p)}b.forEach((s,u)=>{c.data.datasets[u+1].backgroundColor=m.map((p,P)=>u===v&&P===R?`hsl(${h[p]}, 100%, 50%)`:"rgba(0,0,0,0.1)")}),c.update()}else c.data.datasets[0].backgroundColor=m.map(o=>`hsl(${h[o]}, 100%, ${C}%)`),b.forEach((o,i)=>{c.data.datasets[i+1].backgroundColor=Array(12).fill("rgba(0,0,0,0.1)")}),c.update()}$(document).ready(function(){c=new Chart(L.getContext("2d"),U),A=document.getElementById("db-level"),E=document.getElementById("db-value"),$("#recordButton").click(function(){$(this).hasClass("recording")?G():($(this).prop("disabled",!0),EssentiaWASM().then(function(r){B||(n=new EssentiaExtractor(r),n.frameSize=w,n.hopSize=I,n.sampleRate=g.sampleRate,n.profile.HPCP.normalized="none",n.profile.HPCP.harmonics=0,console.log("profile changed"),B=!0),O(g,w,x,function(){$("#recordButton").addClass("recording"),$("#recordButton").html('Stop &nbsp;&nbsp;<i class="stop icon"></i>'),$("#recordButton").prop("disabled",!1)})}))})});
